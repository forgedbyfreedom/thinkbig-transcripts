name: Auto Update Master Transcripts

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # Runs daily at 6 AM UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          echo "ğŸ”§ Installing Python dependencies..."
          pip install -r requirements.txt || echo "No requirements.txt found â€” skipping."
          pip install requests beautifulsoup4 openai || true

      - name: Check working directory
        run: |
          echo "ğŸ“‚ Current working directory:"
          pwd
          echo "ğŸ“‚ Listing contents:"
          ls -la

      - name: Run transcript builder
        run: |
          echo "ğŸš€ Starting master transcript builder..."
          if [ -f "./build_master_transcripts.py" ]; then
            echo "âœ… Found build_master_transcripts.py in current directory."
            python3 ./build_master_transcripts.py
          elif [ -f "${GITHUB_WORKSPACE}/build_master_transcripts.py" ]; then
            echo "âš™ï¸ Running using full GitHub path..."
            python3 "${GITHUB_WORKSPACE}/build_master_transcripts.py"
          else
            echo "âŒ build_master_transcripts.py not found in repo."
            exit 1
          fi

      - name: Commit and push updated transcripts
        run: |
          echo "ğŸª¶ Committing updates to GitHub..."
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"

          git fetch origin main
          git pull --rebase origin main || true

          git add .
          git diff-index --quiet HEAD || git commit -m "Auto-update master transcripts $(date -u +"%Y-%m-%d %H:%M:%S")"

          echo "â¬†ï¸ Attempting push..."
          git push origin main || {
            echo "âš ï¸ Push rejected, retrying with rebase..."
            git pull --rebase origin main
            git push origin main || {
              echo "âŒ Push failed even after rebase."
              exit 1
            }
          }

